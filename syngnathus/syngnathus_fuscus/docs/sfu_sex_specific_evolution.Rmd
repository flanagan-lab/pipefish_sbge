---
title: "fuscus_orthologs"
author: "Sarah P. Flanagan"
date: "`r Sys.Date()`"
output:
  github_document: 
    toc: true 
  #bookdown::pdf_document2:
    #fig_caption: yes
    #keep_tex: yes
    #number_sections: no
    #toc: false
header-includes: >
  \usepackage{lipsum}
  \usepackage{float}
  \floatplacement{figure}{H}
editor_options:
  chunk_output_type: console
---



```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir='../',
                     fig_path="../imgs/")
```

```{r loadlibs, include=FALSE}
library(knitr)
library(kableExtra)
```


The goal is to better understand the sex specific genes -- what's the evolutionary rate? 

So I will first identify orthologs. I've downloaded protein sequences from GenBank:

```{r genomeTable, include=FALSE}
genomes<- data.frame(
  species = c(
    "Syngnathus scovelli",
    "Syngnathus floridae",
    "Syngnathus typhle",
    "Syngnathus acus",
    "Hippocampus zosterae",
    "Hippocampus comes"
  ),
  assembly_id = c(
    "GCF_024217435.2",
    "GCA_010014945.2",
    "GCF_033458585.1",
    "GCF_901709675.1",
    "GCF_025434085.1",
    "GCF_001891065.2"
  ),
  type = c(
    "proteins",
    "fasta and annotations",
    rep("proteins",4)
  )
)
kable(genomes,"latex")
```

Based on the OrthoFinder tutorial on best practices, I'm using the proteomes where available. I have named these S_scovelli.protein.zip etc. Unfortunately Syngnathus floridae did not have a protein file available.

I've downloaded two Hippocampus protein files because in case we are really interested in changes at the Syngnathus fuscus branch (as opposed to comparing across clades) -- according to the [OrthoFinder tutorial](https://davidemms.github.io/orthofinder_tutorials/orthofinder-best-practices.html):

```
If you’re interested in what happened on a particular branch of the species tree, then you should likewise ensure good species sampling—ideally at least two species below the branch, at least two species on the closest branch above and two or more species in the outgroup.
```

I unzipped the ncbi downloads and pulled all the fasta files out into one folder. I'm skipping S. floridae for now. 

I used the orthofinder tool to identify primary transcripts (not sure it did anything, since these are not ensembl files)

```{bash, eval=FALSE}
for f in *faa ; do python ~/Programs/OrthoFinder/tools/primary_transcript.py $f ; done

```

This resulted in a folder called primary_transcripts containing the protein fasta files from the genomes. Note that I have not yet included the S. fuscus transcriptome here. I then identified orthologs:

```{bash, eval=FALSE}
/home/sarah/Programs/OrthoFinder/orthofinder -f primary_transcripts/

```

The overall statistics report that of 112330 genes, 111101 were placed in orthogroups (`r 111101/112330*100` %), which is good. The total number of single-copy orthogroups is 10,504. 

The species tree looks to correctly reflect the known phylogenetic tree structure:

```{r}
library(ape)
ortho_tree <- ape::read.tree(text="((H_comes.protein:0.0356618,H_zosterae.protein:0.0383317)0.987331:0.062338,(S_scovelli.protein:0.0242953,(S_typhle.protein:0.0260101,S_acus.protein:0.016738)0.563686:0.0118948)0.987331:0.062338);")
plot(ortho_tree)
```

The question is what type of transcripts to use, and how to use them. The easiest/current form is SuperTranscripts, which I don't think will work particularly well for this type of analysis. For sure I want to focus on sex-specific genes only. The question is, what *form* of the genes? Here are my ideas so far:

- align supertranscripts to S. scovelli and try to sort out 'correct' orientation of isoforms (eek this will be hard)
- use the longest isoform for this analysis and just use those directly in orthofinder
- put all isoforms into orthofinder, but this will probably result in 0 single copy ones so that's not ideal
- something else?? 

I think I will try (1) and see what the alignments look like. I'll use STAR to align to the S. scovelli genome (according to Stiller et al. 2022, they are most closely related of the available Syngnathus genomes). 

So first, I need to create a genome. I downloaded the data from NCBI using

```{bash, eval=FALSE}
# trinity-em, shared/coley_files/
# get the tools
curl -o datasets 'https://ftp.ncbi.nlm.nih.gov/pub/datasets/command-line/v2/linux-amd64/datasets'
curl -o dataformat 'https://ftp.ncbi.nlm.nih.gov/pub/datasets/command-line/v2/linux-amd64/dataformat'
chmod +x datasets dataformat
# get the data
./datasets download genome accession GCF_024217435.2 --include gff3,rna,cds,protein,genome,seq-report
unzip ncbi_download.zip
mv ncbi_dataset/data/GCF_024217435.2/ ./
mkdir scovelli_genome
```

and install STAR:
```{bash, eval=FALSE}
wget https://github.com/alexdobin/STAR/archive/2.7.11b.tar.gz
tar -xzf 2.7.11b.tar.gz
cd STAR-2.7.11b
cd source
make
cp STAR /usr/local/bin
cp ../bin/STARlong /usr/local/bin
```

Finally, need to retrieve the sex-specific transcript sequences, which are on the FlanaganLab server.

```{r}
"smb://file/Research/FlanaganLab/intermediate_data/SFU_DE_pipeline_analysis_2023/06_diff_expr_analysis/02_high_exp_trinity_gene_seqs"
```



```{bash, eval=FALSE}
# on trinity-em, in shared/coley_files/
# generate genome reference
STAR --runThreadN 6 \
     --runMode genomeGenerate \
     --genomeDir scovelli_genome \
     --genomeFastaFiles GCF_024217435.2/GCF_024217435.2_RoL_Ssco_1.2_genomic.fna \
     --sjdbGTFfile GCF_024217435.2/genomic.gff \
     --genomeSAindexNbases 13
```

Because I'm mapping assembled transcripts to a genome, I need to use the 'long reads' version of STAR (otherwise it does not work properly).

```{bash, eval=FALSE}

for faa in $(ls sex_specific_transcripts/*fasta); do
  name=$(basename $faa .fasta)
  STARlong --genomeDir scovelli_genome/ \
       --runThreadN 6 \
       --readFilesIn $faa \
       --outFileNamePrefix star_fuscus_to_scovelli/${name}_ \
       --outSAMtype BAM SortedByCoordinate \
       --outSAMunmapped Within \
       --outSAMattributes Standard \
       --outFilterMismatchNoverLmax 0.04 \
       --outReadsUnmapped Fastx
done &
```

From these, what I want to know are how the alignments map to the scovelli genome (which genes). So I want to then extract:

```{bash, eval=FALSE}
for bam in $(ls *bam); do
  echo $bam
  samtools view $bam | sed -E 's/(\w+\t\w+\t\w+\t\w+)\t.*/\1/g' #>> alignments.txt
done #this is not working correctly
```

```{bash}
./subread-2.0.8-Linux-x86_64/bin/featureCounts -t exon -g gene --primary -C -a GCF_024217435.2/genomic.gff -o sex-specific_featureCounts star_fuscus_to_scovelli/FU_femG_specific_TRgenes_Aligned.sortedByCoord.out.bam
```




```{r}
"smb://file/Research/FlanaganLab/intermediate_data/SFU_DE_pipeline_analysis_2023/06_diff_expr_analysis/02_high_exp_trinity_gene_seqs"
```


I wonder if I should/could also identify orthologs among S. scovelli, S. floridae, and S. fuscus transcriptomes....?

14 March 2025 - for some reason the alignment only found 2 female-specific gonad genes, so something's gone wrong.
```{bash}
 STAR --genomeDir scovelli_genome/ \
       --runThreadN 6 \
       --readFilesIn test.fasta \
       --outFileNamePrefix test_ \
       --outSAMtype BAM SortedByCoordinate \
       --outSAMunmapped Within \
       --outSAMattributes Standard \
       --outFilterMismatchNoverLmax 0.04
```


( 9249200)

I'll try using STARlong, which is designed for long reads. This seems to have solved the problem!

```{bash, eval=FALSE}
STARlong --genomeDir scovelli_genome/ \
       --runThreadN 6 \
       --readFilesIn sex_specific_transcripts/FU_femG_specific_TRgenes.fasta \
       --outFileNamePrefix star_fuscus_to_scovelli/FU_femG_specific_test \
       --outSAMtype BAM SortedByCoordinate \
       --outSAMunmapped Within \
       --outSAMattributes Standard \
       --outFilterMismatchNoverLmax 0.04 \
       --outReadsUnmapped Fastx \
       --outFilterMatchNmin 20

```


