---
title: "Differential Expression Analysis in _Stigmatopora argus_"
output:
  bookdown::pdf_document2:
    fig_caption: yes
    keep_tex: yes
    number_sections: yes
    toc: true
header-includes: >
  \usepackage{lipsum}
  \usepackage{float}
  \floatplacement{figure}{H}
editor_options:
  chunk_output_type: console
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir='../',fig_path="../imgs/")
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)
```

``` {r library, include = TRUE, message = FALSE, warning = FALSE}
setwd("~/Documents/GitHub/pipefish_sbge/stigmatopora/S_argus")
#This is a cohesive list of all the libraries used in this document
library(DESeq2)
library(pheatmap)
library(RColorBrewer)
library(PCAtools)
library(ggpubr)
library(cowplot)
library(UpSetR)
library(ggplot2)
library(kableExtra)
library(tidyverse)
library(knitr)
library(magick)
library(multcompView)
library(spfTools)
```

``` {r read-data}
#The abundance matrix generated via salmon and tximport to be used for the DE analysis
txi.argus <- readRDS("data/txi.salmon_SA.RDS")

#The samples file generated for tximport
samples <- read.table("data/SA_samples.txt", header = TRUE)

#Make sure the conditions are in the samples file as a factor
samples$sex <- as.factor(samples$sex)
samples$organ <- as.factor(samples$organ)

```

The package `DESeq2` was used for the differential expression analysis outlined below.

# Single factor analysis - Comparing Males v Females across all organs
To analyze your data with DESeq2 you must first generate the DESeqDataSet. In order to do this we need the abundance matrix generated with `tximport` and a `samples` file that lays out all of the conditions. The model for this single factor analysis was run as counts ~ Sex.

```{r DESeqDataSet, message=FALSE, warning=FALSE}
#Create the DESeq dataset
dds_SA <- DESeqDataSetFromTximport(txi.argus, 
                                   colData = samples,
                                   design = ~ sex)

```

The data is then pre-filtered to remove low gene counts before running further DESeq2 functions. By doing this we remove rows in which there are very few reads thus reducing the memory size of the `dds` object and increasing the speed at which we can use the transformation and testing functions in DESeq2.

The cutoff here was to remove rows that had counts fewer than 10 across all samples.

```{r pre-filtering, message=FALSE, warning=FALSE}
#only keeping rows that have at lead 10 reads total
keep <- rowSums(counts(dds_SA)) >= 10
dds_SA <- dds_SA[keep, ]

```

After filtering we can now perform the standard differential expression analysis that is wrapped into DESeq2.

```{r diff-exp, message=FALSE, warning=FALSE}
#Generate the expression values
dds_SA_exp <- DESeq(dds_SA)

#Compile the results
res <- results(dds_SA_exp)
res
```

Once that has finished we can now start exploring some of the single-factor analysis results
```{r investigate-DESeq-results-SA}
##Ordering our results based on p-value
resOrdered <- res[order(res$pvalue),]
resOrdered

summary(res)

#How many ADJUSTED p-values were less than 0.1?
sum(res$padj < 0.1, na.rm = TRUE)

#Looking at  an alpha=0.05, the default is 0.1
res05 <- results(dds_SA_exp, alpha = 0.05)
summary(res05)
head(res05)
sum(res05$padj < 0.05, na.rm = TRUE)

```

1214 MB and 410 FB across all organs, and 0 outliers, seems suspicious. 

## Visualizing the results
### MA-plot - MvF Differntial expression
Generate an MA-plot to show the log2 fold changes attributable to sex over the mean of normalized counts for all of the samples in the `dds`. Points will be colored if the adjusted p-value is less that 0.1.

```{r MA-plot, echo=FALSE, fig.cap="LogFC versus the mean normalized count for all of the genes. Points that are blue have a p-value less than 0.1. The two plots are the same with the only difference coming from an adjusted y-limit. Points that are triangles represent genes with a fold change higher/lower than the y-limit."}

par(mfrow=c(1,2))
plotMA(res, ylim = c(-2,2))
plotMA(res)

```

### Heatmap - overall expression
We can also generate a heat map to look at overall expression levels across our samples. Note, this is not differentially expressed genes.

```{r heatmap, echo=FALSE, fig.cap= "Heatmap showing the expression level across all organs for the top 20 genes with the highest expression levels."}
df <- as.data.frame(samples[,c("sex", "organ")])
rownames(df) <- samples$ID
df$organ <- as.character(df$organ)

organ_cols<-c("GILL" = "#20B2AA",
              "GONAD" = "#EEB422", 
              "LIVER" = "#EE8262")

sex_cols<-c("F" = "#7fc97f", "M" = "#beaed4")

ann_colors = list(sex=sex_cols,
                  organ=organ_cols)

col_order <- c(rownames(df[df$sex=="F" & df$organ=="GILL",]),
               rownames(df[df$sex=="M" & df$organ=="GILL",]),
               rownames(df[df$sex=="F" & df$organ=="GONAD",]),
               rownames(df[df$sex=="M" & df$organ=="GONAD",]),
               rownames(df[df$sex=="F" & df$organ=="LIVER",]),
               rownames(df[df$sex=="M" & df$organ=="LIVER",]))


#Pull out the top 20 rows with the most expression
select <- order(rowMeans(counts(dds_SA_exp, normalized = TRUE)),
                decreasing = TRUE)[1:100]


#Transform the data
vsd <- vst(dds_SA_exp, blind=FALSE)

#Run the heat map with the function pheatmap
pheatmap(assay(vsd)[select, col_order], 
         cluster_rows = FALSE, 
         show_rownames = TRUE, 
         cluster_cols = FALSE, 
         annotation_col = df, 
         annotation_colors = ann_colors)
```

From the heatmap (Fig. \@ref(fig:heatmap)) we can see that for all of these top 20 expressed genes the highest expression in found in the gonads (specifically, three ovaries and two testes), which is different from the other two _Stigmatopora_ spp. and all of the _Syngnathus_ species that had the highest expression in the liver. There are also a few genes that appear to be highly expressed across all of the tissue types. With this heatmap we can also pull out the names of the Trinity genes that are showing this high expression and BLAST the corresponding sequences to see what the genes are.

GONADS - S17 and S32 showing expression patterns unlike the rest of the ovaries. S26 and S38 showing expression patterns unlike the rest of the testes. LIVER - S23 and S45 showing expression patterns unlike the rest of the livers.

```{r heatmap_genes}
#Pull out the corresponding trinity_geneIDS that are plotted in the heatmap
heatmap_TG <- cbind(row.names(assay(vsd)[select,]))
#Run once to create the file and then commented out
#write.table(heatmap_TG,
 #           'heatmap_trinitygenes.txt',
  #          sep = "",
   #         quote=FALSE,
    #        row.names = FALSE,
     #       col.names = FALSE)
```

### Sample-dist Heatmap

We can then generate a sample-to-sample distances heatmap that will give an overview of the similarities and differences between our samples. The darker the colour, the more similar the samples are. The diagonal line of very dark blue represents the comparisson between the same samples.

```{r sample-dist, echo=FALSE, fig.cap="Sample-to-sample distances heatmap showing the similarities and differences between all of the samples. The darker the color, the more similar the samples are. The diagonal line of very dark blue represents the comparissons between the same samples.", warning=FALSE}
#Calculate the sample-to-sample distances from the transformed count matrix
sampleDists <- dist(t(assay(vsd)))

#Transform into a matrix
sampleDistsMatrix <- as.matrix(sampleDists)
rownames(sampleDistsMatrix) <- paste(vsd$sex, vsd$organ, sep = "-")
colnames(sampleDistsMatrix) <- vsd$ID

#Run the heatmap
colors <- colorRampPalette(rev(brewer.pal(9, 'Blues')))(255)
pheatmap(sampleDistsMatrix,
         clustering_distance_rows = sampleDists,
         clustering_distance_cols = sampleDists, 
         col = colors)
```

For the most part, we see that the highest similarities are between samples from the same organ. Notable outliers are S39 (female gill, clustering with livers), S17 (female gonad, clustering with livers), S44 (male gonad, clustering with gills), S46 (male gonad, clustering with gills), and S32 (female gonad, clustering with livers). S23 and S45 (male and female liver clustering with the gonads).

### PCA plots

```{r pca-pairs-plot, echo=FALSE, fig.cap="Principal components analysis pairsplot showing PCA axis 1 - 4."}
#Generate the PCA data to create the pairs plot, using the PCAtools package
p <- pca(assay(vsd), 
         metadata = colData(dds_SA))

#Create the pairs plot
pairsplot(p,
          components = getComponents(p, c(1:4)),
          colby = "organ",
          triangle = FALSE,
          hline = 0, vline = 0,
          colkey = c("GILL" = "#6E8B3D75", 
                     "GONAD" = "#EEB42275", 
                     "LIVER" = "#EE826275"),
          shape = "sex",
          shapekey = c(16, 17),
          pointSize = 3,
          margingaps = unit(c(0.1, 0.1, 0.1, 0.1), 'cm'),
          legendPosition = "left", legendIconSize = 3, legendLabSize = 10)

```


Next we can look at PCA plots for our samples to see how our different samples are grouping.
```{r pca-plot, echo=FALSE, message=FALSE, warning=FALSE}

#Generate the PCA dataframe
pca <- prcomp(t(assay(vsd)))
pca_plotting_data<-as.data.frame(pca$x)

#Add the metadata to the PCA dataset
pca_plotting_data$organ <- samples$organ
pca_plotting_data$sex <- samples$sex
pca_plotting_data$ID <- samples$ID

#Calculate the percent variation attributed to each axis 
percentVar <- round(p$variance, digits = 2)


my_colors <- c("GILL" = "#6E8B3D75", "GONAD" = "#EEB42275", "LIVER" = "#EE826275")
my_shapes <- c(16, 17)

ggplot(pca_plotting_data, aes(x=PC1, y=PC2, color = organ, shape = sex)) +
  scale_color_manual(values = my_colors) +
  scale_shape_manual(values = my_shapes) +
  geom_point(size = 5) +
  xlab(paste0("PC1: ",percentVar[1],"% variance")) +
  ylab(paste0("PC2: ",percentVar[2],"% variance")) + 
  coord_fixed() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  geom_hline(yintercept = 0,
             linetype = 'dashed') +
  geom_vline(xintercept = 0,
             linetype = 'dashed') + 
  geom_text(aes(label = ID), vjust = -1, hjust = 0.5)
```

Samples that are strange: S43 (T8M3), S40 (T8F3), S45 (T8M4), S23 (T6F1), S22 (T6F1), S17 (T1F1), S39 (T8F3)

```{r pca-scaled-sex, echo=FALSE, warning=FALSE}

ggplot(pca_plotting_data, aes(x=PC1, y=PC3, color = organ, shape = sex)) +
  scale_color_manual(values = my_colors) +
  scale_shape_manual(values = my_shapes) +
  geom_point(size = 5) +
  xlab(paste0("PC1: ",percentVar[1],"% variance")) +
  ylab(paste0("PC3: ",percentVar[3],"% variance")) + 
  coord_fixed() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  geom_hline(yintercept = 0,
             linetype = 'dashed') +
  geom_vline(xintercept = 0,
             linetype = 'dashed') + 
  geom_text(aes(label = ID), vjust = -1, hjust = 0.5)

```


```{r pca-scaled-sex, echo=FALSE, warning=FALSE}

ggplot(pca_plotting_data, aes(x=PC1, y=PC4, color = organ, shape = sex)) +
  scale_color_manual(values = my_colors) +
  scale_shape_manual(values = my_shapes) +
  geom_point(size = 5) +
  xlab(paste0("PC1: ",percentVar[1],"% variance")) +
  ylab(paste0("PC4: ",percentVar[4],"% variance")) + 
  coord_fixed() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  geom_hline(yintercept = 0,
             linetype = 'dashed') +
  geom_vline(xintercept = 0,
             linetype = 'dashed') + 
  geom_text(aes(label = ID), vjust = -1, hjust = 0.5)
```

We will eliminate S39 from further analyses because it clusters away from everything else.


# Multifactor design - Comparing M v F across the diff tissue types
If we investigate the column data of our DESeq dataset we can see that each sample has both a sex and organ type attached to it, we will be using these two factors in our multi-factor analysis. In this multi-factor analysis the model was run as counts ~ group, where group included both the sex and the organ type (i.e. MLiver, FLiver, etc.). The sample "S39" appeared to a bit of an outlier in the above analysis, particularly clear in the sample-dist heatmap and the PCA, so it will be removed from the analysis going forward.

```{r multi-factor-analysis, message=FALSE, warning=FALSE}
#Create an additional column the has the two conditions combined(sex and organ type)
samples$group <- factor(paste0(samples$sex, samples$organ))



##Create a copy of the DESeq dataset
ddsMF_SA <- DESeqDataSetFromTximport(txi.argus,
                                     colData = samples,
                                     design = ~ group)

##Remove S39 from the dataset
ddsMF_SA <- ddsMF_SA[, ddsMF_SA$ID != "S39"]

##Filter the dataset, only keeping rows that have at least 10 reads total
keep <- rowSums(counts(ddsMF_SA)) >= 10 & rowSums(counts(ddsMF_SA)) < 1e6
ddsMF_SA <- ddsMF_SA[keep, ]

#Run the differential expression analysis
ddsMF_SA_exp <- DESeq(ddsMF_SA)
resultsNames(ddsMF_SA_exp)

#Looking at the Normalized read counts for each sample
cbind(samples[samples$ID != "S39",],
      normalizedReads=colSums(counts(ddsMF_SA_exp, 
                                     normalized=TRUE)
                              )
      )
```

## Invesitgate the results of the differential expression
Thanks to the multi-factor analysis we can now explore differential expression between all of the different combinations:

  - Male Liver v. Female Liver
  - Male Gill v. Female Gill
  - Male Gonad v. Female Gonad
  - All of the within sex tissue comparisons (e.g. Male Liver v. Male Gill, etc.)

### M-F Liver Comparisson
```{r m-f-liver-results}
##Pulling out the liver M-F results with an alpha of 0.05
liver_con_res <- results(ddsMF_SA_exp, contrast = c("group", "MLIVER", "FLIVER"),
                         alpha = 0.05)
liver_con_res$trin_geneid <- rownames(liver_con_res)
head(liver_con_res)

summary(liver_con_res)
```

There are many criteria that have been employed previously to denote sex bias. For this study we are classifying sex-biased genes as **genes with a p-value < 0.05 AND a logFC $\ge$ |2|**. With that criteria in the liver there are `r sum(liver_con_res$padj <= 0.05 & liver_con_res$log2FoldChange >= 2, na.rm = TRUE)` male-biased genes and `r sum(liver_con_res$padj <= 0.05 & liver_con_res$log2FoldChange <= -2, na.rm = TRUE)` female-biased genes. 

I have then pulled out all of the male-biased, female-biased, and non-biased genes based on the criteria outlined above. I determined non-biased genes as a p-vaule > 0.05.

```{r liver-sex-biased}
#Removing the rows where padj. is NA in results
liver_con_res_noNA <- liver_con_res[!is.na(liver_con_res$padj),]
summary(liver_con_res_noNA) #We can now see that there are no outliers or low counts since the NAs have been removed

#Creating a vector that contains all of the male-biased and female-biased genes in the liver
liver_mal_biased <- liver_con_res_noNA[which(liver_con_res_noNA$log2FoldChange >= 2
                                             & liver_con_res_noNA$padj <= 0.05),]
liver_fem_biased <- liver_con_res_noNA[which(liver_con_res_noNA$log2FoldChange <= -2 
                                             & liver_con_res_noNA$padj <= 0.05),]

#Creating an object that contains all of the non-biased genes in the liver
liver_non_biased <- liver_con_res_noNA[which(liver_con_res_noNA$padj > 0.05),]

```

I will be generating a table that outlines the genes that are the most male or female biased in each organ type. To do this I need to pull the top 50 differentially expressed genes in males or females, get the Trinity gene IDs and then BLAST the corresponding sequences. Here I am pulling out the Trinity gene IDs for those genes.

```{r top50-liver}
#Creating a subset of the results where the p-value is less than 0.05
liver_con_res_p05 <- liver_con_res_noNA[liver_con_res_noNA$padj <= 0.05, ]


#Pulling the top 50 diff expressed genes in Males
top50_MLiver_trin_genes <- cbind(rownames(head(liver_con_res_p05[order(
  liver_con_res_p05$log2FoldChange, decreasing = TRUE),], n=50)))
#Run once to create the file and then commented out
#write.table(top50_MLiver_trin_genes,
 #          'SA_maleL_top50TRgenes.txt', 
  #         sep = "", 
   #        quote=FALSE, 
    #         row.names = FALSE, 
     #        col.names = FALSE)

#Pulling the top 50 diff expressed genes in Females
top50_Fliver_trin_genes <- cbind(rownames(head(liver_con_res_p05[order(
  liver_con_res_p05$log2FoldChange, decreasing = FALSE),], n=50)))

#Run once to create the file and then commented out
#write.table(top50_Fliver_trin_genes,
 #           'SA_femL_top50TRgenes.txt', 
  #          sep = "", 
   #         quote=FALSE, 
    #        row.names = FALSE, 
     #       col.names = FALSE)
```

### M-F Gill Comparisson
```{r m-f-gill}
##Pulling out the gill M-F results
gill_con_res <- results(ddsMF_SA_exp, contrast = c("group", "MGILL", "FGILL"),
                        alpha = 0.05)
gill_con_res$trin_geneid <- rownames(gill_con_res)
head(gill_con_res)

summary(gill_con_res)
```

In the gills there were `r sum(gill_con_res$padj <= 0.05 & gill_con_res$log2FoldChange >= 2, na.rm = TRUE)` genes that we can consider male-biased and `r sum(gill_con_res$padj <= 0.05 & gill_con_res$log2FoldChange <= -2, na.rm = TRUE)` female-biased genes based on our criteria for sex-bias.

I have then pulled out all of the male-biased, female-biased, and non-biased genes to save them into their own objects.

```{r gill-sex-biased}
#Removing the rows where padj. is NA in results
gill_con_res_noNA <- gill_con_res[!is.na(gill_con_res$padj), ]
summary(gill_con_res_noNA) #We can now see that there are no outliers or 
                           #low counts since the NAs have been removed

#Creating a vector that contains all of the male-biased and female-biased genes in the gills
gill_mal_biased <- gill_con_res_noNA[which(gill_con_res_noNA$log2FoldChange >= 2 
                                           & gill_con_res_noNA$padj <= 0.05),]
gill_fem_biased <- gill_con_res_noNA[which(gill_con_res_noNA$log2FoldChange <= -2 
                                           & gill_con_res_noNA$padj <= 0.05),]

#Creating an object that contains all of the non-biased genes in the gills, p>0.05
gill_non_biased <- gill_con_res_noNA[which(gill_con_res_noNA$padj > 0.05),]
```

Here I am getting the trinity gene IDs that correspond to the top 50 differentially expressed genes for males and females. Because there are only 27 female-biased and male-biased genes I will only use those.

```{r top50-gill}
#Creating a subset of results where p-value is less than 0.05
gill_con_res_p05 <- gill_con_res_noNA[gill_con_res_noNA$padj <= 0.05,]

#Pulling the top 27 diff expressed genes in Males
top27_MGill_trin_genes <- cbind(rownames(head(gill_con_res_p05[order(
  gill_con_res_p05$log2FoldChange, decreasing = TRUE),], n=27)))

#Run once to create the file and then commented out
#write.table(top27_MGill_trin_genes,
 #           'SA_maleG_top27TRgenes.txt', 
  #          sep = "", 
   #         quote=FALSE, 
    #        row.names = FALSE, 
     #       col.names = FALSE)

#Pulling the top 27 diff expressed genes in Females 
top27_FGill_trin_genes <- cbind(rownames(head(gill_con_res_p05[order(
  gill_con_res_p05$log2FoldChange, decreasing = FALSE),], n=27)))

#Run once to create the file and then commented out
#write.table(top27_FGill_trin_genes,
 #           'SA_femG_top27TRgenes.txt', 
  #          sep = "", 
   #         quote=FALSE, 
    #        row.names = FALSE, 
     #       col.names = FALSE)
```

### M-F Gonad Comparisson
```{r m-f-gonads}
##Pulling out the gonad M-F results
gonad_con_res <- results(ddsMF_SA_exp, 
                         contrast = c("group", "MGONAD", "FGONAD"),
                         alpha = 0.05)
gonad_con_res$trin_geneid <- rownames(gonad_con_res)
head(gonad_con_res)

summary(gonad_con_res)
```

Between the ovaries and testes (gonads) there were `r sum(gonad_con_res$padj <= 0.05 & gonad_con_res$log2FoldChange >= 2, na.rm = TRUE)` genes that we can consider male-biased and `r sum(gonad_con_res$padj <= 0.05 & gonad_con_res$log2FoldChange <= -2, na.rm = TRUE)` female-biased genes based on our criteria for sex-bias.

From the gonad M-F results I have then pulled out all of the male-biased, female-biased, and non-biased genes and saved them to their own objects.

```{r gonad-sex-biased}
#Removing the rows where padj. is NA in results
gonad_con_res_noNA <- gonad_con_res[!is.na(gonad_con_res$padj), ]
summary(gonad_con_res_noNA) #We can now see that there are no outliers or 
                            #low counts since the NAs have been removed

#Creating an object that contains all of the male-biased and female-biased genes in the gonads
gonad_mal_biased <- gonad_con_res_noNA[which(gonad_con_res_noNA$log2FoldChange >= 2 
                                             & gonad_con_res_noNA$padj <= 0.05),]
gonad_fem_biased <- gonad_con_res_noNA[which(gonad_con_res_noNA$log2FoldChange <= -2 
                                             & gonad_con_res_noNA$padj <= 0.05),]

#Creating an object that contains all of the non-biased genes in the gonads, p>0.05
gonad_non_biased <- gonad_con_res_noNA[which(gonad_con_res_noNA$padj > 0.05),]
```

I then pulled out the trinity gene IDs that corresponded to the top 50 differentially expressed genes in males and females so that I could BLAST the sequences.
```{r top50-gonad}
#Creating a subset of the results where the p-value is less than 0.05
gonad_con_res_p05 <- gonad_con_res_noNA[gonad_con_res_noNA$padj <= 0.05,]

#Pulling the top 50 diff expressed genes in Males
top50_MGonad_trin_genes <- cbind(rownames(head(gonad_con_res_p05[order(
  gonad_con_res_p05$log2FoldChange, decreasing = TRUE),], n=50)))

#Run once to create the file and then commented out
#write.table(top50_MGonad_trin_genes,
 #        'SA_maleGon_top50TRgenes.txt', 
  #        sep = "", 
   #       quote=FALSE, 
    #      row.names = FALSE, 
     #     col.names = FALSE)

#Pulling the top 50 diff expressed genes in Females
top50_FGonad_trin_genes <- cbind(rownames(head(gonad_con_res_p05[order(
  gonad_con_res_p05$log2FoldChange, decreasing = FALSE),], n=50)))

#Run once to create the file and then commented out
#write.table(top50_FGonad_trin_genes,
 #           'SA_femGon_top50TRgenes.txt', 
  #          sep = "", 
   #         quote=FALSE, 
    #        row.names = FALSE, 
     #       col.names = FALSE)
```

## Investigating expression across samples in the sex-biased genes

```{r heatmap_gonads, echo=FALSE}

#Set the colors used for the heatmap labeling
organ_cols<-c("GILL" = "#20B2AA",
              "GONAD" = "#EEB422", 
              "LIVER" = "#EE8262")

sex_cols<-c("F" = "#7fc97f", "M" = "#beaed4")

ann_colors = list(sex=sex_cols,
                  organ=organ_cols)

#Transform the multi-factor data
vsd_MF <- vst(ddsMF_SA_exp, blind=FALSE)

#Set the information for how you want the columns to show up
df <- as.data.frame(colData(ddsMF_SA_exp))


col_order <- c(
  rownames(df[df$organ == "GILL" & df$sex=="F",]),
  rownames(df[df$organ == "GILL" & df$sex=="M",]),
  rownames(df[df$organ == "LIVER" & df$sex=="F",]),
  rownames(df[df$organ == "LIVER" & df$sex=="M",]),
  rownames(df[df$organ == "GONAD" & df$sex=="F",]),
  rownames(df[df$organ == "GONAD" & df$sex=="M",])
)


#Pull out the top 200 male-biased genes
select_mal_gonad <- rownames(gonad_mal_biased[order(gonad_mal_biased$log2FoldChange,
                                                         decreasing = TRUE),])


pheatmap(assay(vsd_MF)[select_mal_gonad, col_order], 
              cluster_rows = FALSE, 
              show_rownames = FALSE, 
              cluster_cols = FALSE, 
              show_colnames = FALSE,
              annotation_col = df[1:3],
              annotation_colors=ann_colors,
              fontsize = 15,
              annotation_legend = TRUE,
              main = "Male-biased genes in the Testes")

#Pull out the top 200 female-biased genes
select_fem_gonad <- rownames(gonad_fem_biased[order(gonad_fem_biased$log2FoldChange,
                                                         decreasing = FALSE),])

pheatmap(assay(vsd_MF)[select_fem_gonad, col_order], 
              cluster_rows = FALSE, 
              show_rownames = FALSE, 
              cluster_cols = FALSE, 
              show_colnames = FALSE,
              annotation_col = df[1:3],
              annotation_colors=ann_colors,
              fontsize = 15,
              annotation_legend = TRUE,
              main = "Female-biased genes in the Ovaries")


```


```{r heatmap_gills, echo=FALSE}

#Pull out the male-biased genes
select_mal_gill <- rownames(gill_mal_biased[order(gill_mal_biased$log2FoldChange,
                                                         decreasing = TRUE),])


pheatmap(assay(vsd_MF)[select_mal_gill, col_order], 
              cluster_rows = FALSE, 
              show_rownames = FALSE, 
              cluster_cols = FALSE, 
              show_colnames = FALSE,
              annotation_col = df[1:3],
              annotation_colors=ann_colors,
              fontsize = 15,
              annotation_legend = TRUE,
              main = "Male-biased genes in the Gills")

#Pull out the top female-biased genes
select_fem_gill <- rownames(gill_fem_biased[order(gill_fem_biased$log2FoldChange,
                                                         decreasing = FALSE),])

pheatmap(assay(vsd_MF)[select_fem_gill, col_order], 
              cluster_rows = FALSE, 
              show_rownames = FALSE, 
              cluster_cols = FALSE, 
              show_colnames = FALSE,
              annotation_col = df[1:3],
              annotation_colors=ann_colors,
              fontsize = 15,
              annotation_legend = TRUE,
              main = "Female-biased genes in the Gills")


```

```{r heatmap_liver, echo=FALSE}

#Pull out the male-biased genes
select_mal_liver <- rownames(liver_mal_biased[order(liver_mal_biased$log2FoldChange,
                                                         decreasing = TRUE),])


pheatmap(assay(vsd_MF)[select_mal_liver, col_order], 
              cluster_rows = FALSE, 
              show_rownames = FALSE, 
              cluster_cols = FALSE, 
              show_colnames = FALSE,
              annotation_col = df[1:3],
              annotation_colors=ann_colors,
              fontsize = 15,
         border_color = NA,
              annotation_legend = TRUE,
              main = "Male-biased genes in the Liver")

#Pull out the top female-biased genes
select_fem_liver <- rownames(liver_fem_biased[order(liver_fem_biased$log2FoldChange,
                                                         decreasing = FALSE),])

pheatmap(assay(vsd_MF)[select_fem_liver, col_order], 
              cluster_rows = FALSE, 
              show_rownames = FALSE, 
              cluster_cols = FALSE, 
              show_colnames = FALSE,
              annotation_col = df[1:3],
              annotation_colors=ann_colors,
         border_color = NA,
              fontsize = 15,
              annotation_legend = TRUE,
              main = "Female-biased genes in the Liver")


```

# Running a single factor analysis between males and females WITHIN each organ
## Liver M-F differential expression

```{r liver-sf-analysis, message=FALSE}
#Create a subset of the DESeq dataset that only includes the liver samples
dds_SA_liver <- ddsMF_SA[, ddsMF_SA$organ == "LIVER"]

#Filtering to remove any rows that have less than 10 reads total
keep <- rowSums(counts(dds_SA_liver)) >= 10
dds_SA_liver <- dds_SA_liver[keep, ]

design(dds_SA_liver) <- ~ sex

#Run the differential expression analysis
dds_SA_liver_exp <- DESeq(dds_SA_liver)

#Compiling the results
res_liver <- results(dds_SA_liver_exp, alpha = 0.05)

summary(res_liver)

```

The single factor analysis from the liver showed `r sum(res_liver$padj <= 0.05 & res_liver$log2FoldChange >= 2, na.rm = TRUE)` male-biased genes and `r sum(res_liver$padj <= 0.05 & res_liver$log2FoldChange <= -2, na.rm = TRUE)` female-biased genes. I am going to pull out all of the female- and male-biased genes to store them in their own objects as well as genes that are non-biased. Non-biased genes will be categorized as genes with a p-value > 0.05, regardless of what the logFC may be.

```{r liver-sf-sexbiased}
#Removing the rows where padj. is NA in results
liver_res_noNA <- res_liver[!is.na(res_liver$padj),]
summary(liver_res_noNA) #We can now see that there are no outliers or 
                            #low counts since the NAs have been removed
#write.csv(as.data.frame(liver_res_noNA), "data/liver_res.csv", row.names = TRUE)

#Creating a vector that contains all of the male-biased and female-biased genes in the brain
liver_mal_biased <- liver_res_noNA[which(liver_res_noNA$log2FoldChange >= 2
                                             & liver_res_noNA$padj <= 0.05),]
liver_fem_biased <- liver_res_noNA[which(liver_res_noNA$log2FoldChange <= -2 
                                             & liver_res_noNA$padj <= 0.05),]

#Creating an object that contains all of the non-biased genes in the brain
liver_non_biased <- liver_res_noNA[which(liver_res_noNA$padj > 0.05),]
```

## Gonad M-F differential expression

```{r gonad-sf-analysis, message=FALSE}
#Create a subset of the DESeq dataset that only includes the gonad samples
dds_SA_gonad <- ddsMF_SA[, ddsMF_SA$organ == "GONAD"]

#Filtering to remove any rows that have less than 10 reads total
keep <- rowSums(counts(dds_SA_gonad)) >= 10
dds_SA_gonad <- dds_SA_gonad[keep, ]

design(dds_SA_gonad) <- ~ sex

#Run the differential expression analysis
dds_SA_gonad_exp <- DESeq(dds_SA_gonad)

#Compiling the results
res_gonad <- results(dds_SA_gonad_exp, alpha = 0.05)

summary(res_gonad)

```

The single factor analysis from the gonad showed `r sum(res_gonad$padj <= 0.05 & res_gonad$log2FoldChange >= 2, na.rm = TRUE)` male-biased genes and `r sum(res_gonad$padj <= 0.05 & res_gonad$log2FoldChange <= -2, na.rm = TRUE)` female-biased genes. I am going to pull out all of the female- and male-biased genes to store them in their own objects as well as genes that are non-biased. Non-biased genes will be categorized as genes with a p-value > 0.05, regardless of what the logFC may be.

```{r gonad-sf-sexbiased}
#Removing the rows where padj. is NA in results
gonad_res_noNA <- res_gonad[!is.na(res_gonad$padj),]
summary(gonad_res_noNA) #We can now see that there are no outliers or 
                            #low counts since the NAs have been removed
#write.csv(as.data.frame(gonad_res_noNA), "data/gonad_res.csv", row.names = TRUE)

#Creating a vector that contains all of the male-biased and female-biased genes in the brain
gonad_mal_biased <- gonad_res_noNA[which(gonad_res_noNA$log2FoldChange >= 2
                                             & gonad_res_noNA$padj <= 0.05),]
gonad_fem_biased <- gonad_res_noNA[which(gonad_res_noNA$log2FoldChange <= -2 
                                             & gonad_res_noNA$padj <= 0.05),]

#Creating an object that contains all of the non-biased genes in the brain
gonad_non_biased <- gonad_res_noNA[which(gonad_res_noNA$padj > 0.05),]
```

## Gill M-F differential expression

```{r gill-sf-analysis, message=FALSE}
#Create a subset of the DESeq dataset that only includes the gill samples
dds_SA_gill <- ddsMF_SA[, ddsMF_SA$organ == "GILL"]

#Filtering to remove any rows that have less than 10 reads total
keep <- rowSums(counts(dds_SA_gill)) >= 10
dds_SA_gill <- dds_SA_gill[keep, ]

design(dds_SA_gill) <- ~ sex

#Run the differential expression analysis
dds_SA_gill_exp <- DESeq(dds_SA_gill)

#Compiling the results
res_gill <- results(dds_SA_gill_exp, alpha = 0.05)

summary(res_gill)

```

The single factor analysis from the gill showed `r sum(res_gill$padj <= 0.05 & res_gill$log2FoldChange >= 2, na.rm = TRUE)` male-biased genes and `r sum(res_gill$padj <= 0.05 & res_gill$log2FoldChange <= -2, na.rm = TRUE)` female-biased genes. I am going to pull out all of the female- and male-biased genes to store them in their own objects as well as genes that are non-biased. Non-biased genes will be categorized as genes with a p-value > 0.05, regardless of what the logFC may be.

```{r gill-sf-sexbiased}
#Removing the rows where padj. is NA in results
gill_res_noNA <- res_gill[!is.na(res_gill$padj),]
summary(gill_res_noNA) #We can now see that there are no outliers or 
                            #low counts since the NAs have been removed
#write.csv(as.data.frame(gill_res_noNA), "data/gill_res.csv", row.names = TRUE)

#Creating a vector that contains all of the male-biased and female-biased genes in the brain
gill_mal_biased <- gill_res_noNA[which(gill_res_noNA$log2FoldChange >= 2
                                             & gill_res_noNA$padj <= 0.05),]
gill_fem_biased <- gill_res_noNA[which(gill_res_noNA$log2FoldChange <= -2 
                                             & gill_res_noNA$padj <= 0.05),]

#Creating an object that contains all of the non-biased genes in the brain
gill_non_biased <- gill_res_noNA[which(gill_res_noNA$padj > 0.05),]
```


## Re-looking at variation in logFC across both sex-bias categories and tissue types
I want to now re-create the plot the highlights the variation we see in fold-change both across the different biases groups (male-biased, female-biased, and non-biased) within one tissue type and across all of the tissue types to see if the weird patterns are still there. To do this I first need to re-generate the "long" style dataset with the new information:

```{r logFC-long-dataset-SFanalysis}
logFC_long <- data.frame(
  tissue=c(rep("Gill",nrow(gill_fem_biased)),
           rep("Gill", nrow(gill_mal_biased)),
           rep("Gill", nrow(gill_non_biased)),
           rep("Gonad", nrow(gonad_fem_biased)),
           rep("Gonad", nrow(gonad_mal_biased)),
           rep("Gonad", nrow(gonad_non_biased)),
           rep("Liver", nrow(liver_fem_biased)),
           rep("Liver", nrow(liver_mal_biased)),
           rep("Liver", nrow(liver_non_biased))
         ),
  bias=c(rep("FB",nrow(gill_fem_biased)),
         rep("MB",nrow(gill_mal_biased)),
         rep("NB", nrow(gill_non_biased)),
         rep("FB", nrow(gonad_fem_biased)),
         rep("MB", nrow(gonad_mal_biased)),
         rep("NB", nrow(gonad_non_biased)),
         rep("FB", nrow(liver_fem_biased)),
         rep("MB", nrow(liver_mal_biased)),
         rep("NB", nrow(liver_non_biased))
         ),
  logFC=c(gill_fem_biased$log2FoldChange,
          gill_mal_biased$log2FoldChange,
          gill_non_biased$log2FoldChange,
          gonad_fem_biased$log2FoldChange,
          gonad_mal_biased$log2FoldChange,
          gonad_non_biased$log2FoldChange,
          liver_fem_biased$log2FoldChange,
          liver_mal_biased$log2FoldChange,
          liver_non_biased$log2FoldChange
          ),
  geneID=c(rownames(gill_fem_biased),
           rownames(gill_mal_biased),
           rownames(gill_non_biased),
           rownames(gonad_fem_biased),
           rownames(gonad_mal_biased),
           rownames(gonad_non_biased),
           rownames(liver_fem_biased),
           rownames(liver_mal_biased),
           rownames(liver_non_biased)
           )
)
#Exporting this data, run once and then commented out
#write.csv(logFC_long, "data/logFC_long_sexbias.csv", row.names = FALSE)
```
After re-creating the long version of the dataset I can re-generate the plot.

```{r FC-var-plot-SFanalysis, echo=FALSE, fig.cap="Absolute value of the logFC for genes that are female-biased, male-biased, and unbiased across each tissue type. Raw fold-change values are added ontop of the boxplot as jitters."}
pdf("figs/FigSF_logFC_boxplots.pdf", width = 10, height=4)
sex_bias_colors <- c("FB" = "#7FC97F",
                     "MB" = "#BEAED4",
                     "UB" = "darkgray")
ymax <- max(abs(logFC_long$logFC),
            na.rm = TRUE) + 5
organs <- levels(as.factor(logFC_long$tissue))
par(mfrow=c(1,3),
    oma=c(4,5,2,8),
    mar=c(1,1,1,0))
for(organ in organs){
   # add jittered points
   plot(abs(logFC_long$logFC[logFC_long$tissue==organ]) ~
            jitter(as.numeric(as.factor(logFC_long$bias[logFC_long$tissue==organ]))),
        col="#00000075",
        axes=FALSE,
        cex.main=2,
        xlim=c(0,4),
        ylim=c(0,ymax)
        )
   # make the boxplot
   boxplot(abs(logFC_long$logFC[logFC_long$tissue==organ]) ~
             logFC_long$bias[logFC_long$tissue==organ],
           col=scales::alpha(sex_bias_colors,0.75),
           add = TRUE,
           yaxt='n',
           las=1,
           cex.axis=1.75,
           frame=FALSE,
           lwd=1.5,
           outline=FALSE# do not plot outliers
           )
   # make the axis lines longer and thicker
   axis(1, labels=NA,
        at=-1:4,
        lwd=2,
        lwd.ticks=0,
        las = 3,
        cex.axis = 1.5)
   axis(2, labels=seq(-5,ymax,10),
        line=NA,
        at=seq(-5,ymax,10),
        lwd=2,
        ylim=c(0,ymax),
        cex.axis=2,
        las=2)
   mtext(organ, cex=1.5,outer=FALSE, line=-1)
}
# add x axis label
mtext("Bias level",side = 1,cex=1.5, outer=TRUE, line=2)
# add y axis label
mtext(expression("|log"[2]*"FC|"),side = 2,cex=1.5, outer=TRUE, line=2.25)
# add legend
spfTools::outer_legend("right",
                       legend=c("Female\nbiased",
                                "Male\nbiased",
                                "Unbiased"),
                       pt.bg=sex_bias_colors,
                       pch=22,
                       bty='n',
                       ncol=1,
                       cex=2,
                       y.intersp = 1.5,
                       pt.cex=2)
dev.off()
```

## Investigating expression across samples in the sex-biased genes
For each organ type I am going to pull out either all of the sex-biased genes, or just the top 200 if there are more than that, and look at the expression levels of those genes across all of the samples.

```{r heatmap_gonads, echo=FALSE}
#Set the colors used for the heatmap labeling
sex_cols <- c("F" = "#7FC97F", "M" = "#BEAED4" )
ann_colors = list(sex=sex_cols)

#Transform the data
vsd_gonad <- vst(dds_SA_gonad_exp, blind=FALSE)

#Set the information for how you want the columns to show up
df_gonad <- as.data.frame(colData(dds_SA_gonad_exp))
col_order_gonad <- c(
  rownames(df_gonad[df_gonad$sex=="F",]),
  rownames(df_gonad[df_gonad$sex=="M",])
)
#Pull out the top 200 male-biased genes
select_mal_gonad <- rownames(head(gonad_mal_biased[order(gonad_mal_biased$log2FoldChange,
                                                         decreasing = TRUE),],
                                  n=200))
gonadM_HM <- pheatmap(assay(vsd_gonad)[select_mal_gonad, col_order_gonad],
              cluster_rows = FALSE,
              show_rownames = FALSE,
              cluster_cols = FALSE,
              show_colnames = FALSE,
              annotation_col = df_gonad[2],
              annotation_colors=ann_colors,
              fontsize = 15,
              annotation_legend = FALSE,
              border_color = NA,
              main = "Male-biased genes in the Testes")
#Pull out the top 200 female-biased genes
select_fem_gonad <- rownames(head(gonad_fem_biased[order(gonad_fem_biased$log2FoldChange,
                                                         decreasing = FALSE),],
                                  n=200))
gonadF_HM <- pheatmap(assay(vsd_gonad)[select_fem_gonad, col_order_gonad],
              cluster_rows = FALSE,
              show_rownames = FALSE,
              cluster_cols = FALSE,
              show_colnames = FALSE,
              annotation_col = df_gonad[2],
              annotation_colors=ann_colors,
              fontsize = 15,
              annotation_legend = FALSE,
              border_color = NA,
              main = "Female-biased genes in the Ovaries")

pheatmap(assay(vsd_gonad)[, col_order_gonad],
              cluster_rows = FALSE,
              show_rownames = FALSE,
              cluster_cols = FALSE,
              show_colnames = FALSE,
              annotation_col = df_gonad[2],
              annotation_colors=ann_colors,
              fontsize = 15,
              annotation_legend = FALSE,
              border_color = NA,
              main = "Expression in Gonads")
```
```{r heatmap_liver, echo=FALSE}
#Transform the data
vsd_liver <- vst(dds_SA_liver_exp, blind=FALSE)
#Set the information for how you want the columns to show up
df_liver <- as.data.frame(colData(dds_SA_liver_exp))
col_order_liver <- c(
  rownames(df_liver[df_liver$sex=="F",]),
  rownames(df_liver[df_liver$sex=="M",])
)
#Pull out the male-biased genes
select_mal_liver <- rownames(head(liver_mal_biased[order(liver_mal_biased$log2FoldChange,
                                                         decreasing = TRUE),],
                                  n=200))
liverM_HM <- pheatmap(assay(vsd_liver)[select_mal_liver, col_order_liver],
              cluster_rows = FALSE,
              show_rownames = FALSE,
              cluster_cols = FALSE,
              show_colnames = FALSE,
              border_color=NA,
              annotation_col = df_liver[2],
              annotation_colors=ann_colors,
              fontsize = 15,
              annotation_legend = FALSE,
              main = "Male-biased genes in the Liver")
#Pull out the female-biased genes
select_fem_liver <- rownames(head(liver_fem_biased[order(liver_fem_biased$log2FoldChange,
                                                         decreasing = FALSE),],
                                  n=200))
liverF_HM <- pheatmap(assay(vsd_liver)[select_fem_liver, col_order_liver],
              cluster_rows = FALSE,
              show_rownames = FALSE,
              cluster_cols = FALSE,
              show_colnames = FALSE,
              annotation_col = df_liver[2],
              annotation_colors=ann_colors,
              border_color=NA,
              fontsize = 15,
              annotation_legend = FALSE,
              main = "Female-biased genes in the Liver")
```
```{r heatmap_gill, echo=FALSE}
#Transform the data
vsd_gill <- vst(dds_SA_gill_exp, blind=FALSE)
#Set the information for how you want the columns to show up
df_gill <- as.data.frame(colData(dds_SA_gill_exp))
col_order_gill <- c(
  rownames(df_gill[df_gill$sex=="F",]),
  rownames(df_gill[df_gill$sex=="M",])
)
#Pull out the male-biased genes
select_mal_gill <- rownames(head(gill_mal_biased[order(gill_mal_biased$log2FoldChange,
                                                         decreasing = TRUE),],
                                  n=200))
gillM_HM <- pheatmap(assay(vsd_gill)[select_mal_gill, col_order_gill],
              cluster_rows = FALSE,
              show_rownames = FALSE,
              cluster_cols = FALSE,
              show_colnames = FALSE,
              border_color=NA,
              annotation_col = df_gill[2],
              annotation_colors=ann_colors,
              fontsize = 15,
              annotation_legend = FALSE,
              main = "Male-biased genes in the gill")
#Pull out the female-biased genes
select_fem_gill <- rownames(head(gill_fem_biased[order(gill_fem_biased$log2FoldChange,
                                                         decreasing = FALSE),],
                                  n=200))
gillF_HM <- pheatmap(assay(vsd_gill)[select_fem_gill, col_order_gill],
              cluster_rows = FALSE,
              show_rownames = FALSE,
              cluster_cols = FALSE,
              show_colnames = FALSE,
              annotation_col = df_gill[2],
              annotation_colors=ann_colors,
              border_color=NA,
              fontsize = 15,
              annotation_legend = FALSE,
              main = "Female-biased genes in the gill")
```

